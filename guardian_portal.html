<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بوابة الولي</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 id="guardianName"></h2>
  <p>إجمالي الدفعات غير الخالصة: <span id="totalUnpaid"></span></p>

  <h3>أبناؤك</h3>
  <table id="children" class="datatable">
    <thead>
      <tr><th>الاسم</th><th>المستوى</th><th>الديون</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>الدفعات غير الخالصة</h3>
  <table id="payments" class="datatable">
    <thead>
      <tr><th>الفترة</th><th>المبلغ</th><th>الطالب</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>الغيابات</h3>
  <table id="absences" class="datatable">
    <thead>
      <tr><th>الطالب</th><th>التاريخ</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>الملاحظات</h3>
  <table id="notes" class="datatable">
    <thead>
      <tr><th>الطالب</th><th>الملاحظة</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>جدول الحصص</h3>
  <table id="schedule" class="timetable">
    <thead>
      <tr>
        <th>التوقيت</th>
        <th>الإثنين</th>
        <th>الثلاثاء</th>
        <th>الأربعاء</th>
        <th>الخميس</th>
        <th>الجمعة</th>
        <th>السبت</th>
        <th>الأحد</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="guardian_script.js"></script>
  <script src="schedule_script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            return;
        }
    
        const guardian = JSON.parse(guardianData);
    
        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;
        document.getElementById("totalUnpaid").innerText = `${guardian.unpaid_total.toFixed(2)} دينار`;
    
        const students = await fetch("students.json").then(res => res.json());
        
        const children = students.filter(student => guardian.student_ids.includes(student.id));
    
        const childrenTable = document.getElementById("children").getElementsByTagName('tbody')[0];
        const paymentsTable = document.getElementById("payments").getElementsByTagName('tbody')[0];
        const absencesTable = document.getElementById("absences").getElementsByTagName('tbody')[0];
        const notesTable = document.getElementById("notes").getElementsByTagName('tbody')[0]; // جدول الملاحظات
    
        children.forEach(student => {
            let childRow = childrenTable.insertRow();
            childRow.innerHTML = `<td>${student.name} ${student.surname}</td><td>${student.educational_level}</td><td>${student.unpaid_total.toFixed(2)}</td>`;
    
            student.unpaid_periods.forEach(payment => {
                let paymentRow = paymentsTable.insertRow();
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });

            if (student.absence_count) {
              student.absence_count.forEach(absenceDate => {
                  let absenceRow = absencesTable.insertRow();
                  absenceRow.innerHTML = `<td>${student.name}</td><td>${absenceDate}</td>`;
              });
            }

            // إضافة الملاحظات
            if (student.notes) {
                student.notes.forEach(note => {
                    let noteRow = notesTable.insertRow();
                    noteRow.innerHTML = `<td>${student.name}</td><td>${note}</td>`;
                });
            }
        });
    });
    
    buildSchedule("schedule");
  </script>
</body>
</html>
