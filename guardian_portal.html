<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بوابة الولي</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h3>مرحباً بك في بوابة الولي</h3>
  <p>
    في هذه الصفحة، ستجد ملخصًا شاملاً لمتابعة المسار الدراسي لأبنائك. يمكنك الاطلاع على قائمة أبنائك المسجلين مع تفاصيل ديونهم و غياباتهم، بالإضافة إلى جدول الدفعات غير الخالصة وجدول الحصص الأسبوعي.
  </p>
  <hr>

  <h2 id="guardianName"></h2>

  <h3>أبناؤك</h3>
  <table id="children" class="datatable">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>المستوى</th>
        <th>الديون</th>
        <th>الغيابات</th>
        <th>ملاحظات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p>إجمالي الدفعات غير الخالصة: <span id="totalUnpaid"></span></p>

  <h3>الدفعات غير الخالصة</h3>
  <table id="payments" class="datatable">
    <thead>
      <tr><th>الفترة</th><th>المبلغ</th><th>الطالب</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>جدول الحصص</h3>
  <table id="schedule" class="timetable">
    <thead>
      <tr>
        <th>التوقيت</th>
        <th>الإثنين</th>
        <th>الثلاثاء</th>
        <th>الأربعاء</th>
        <th>الخميس</th>
        <th>الجمعة</th>
        <th>السبت</th>
        <th>الأحد</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="guardian_script.js"></script>
  <script src="schedule_script.js"></script>
  <script>
    // انتظر حتى يتم تحميل محتوى الصفحة بالكامل
    document.addEventListener("DOMContentLoaded", async () => {
        // قراءة بيانات الولي من ذاكرة الجلسة
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            // في حال عدم وجود بيانات، لا تفعل شيئًا
            return;
        }
    
        const guardian = JSON.parse(guardianData);
    
        // عرض اسم الولي وإجمالي الديون
        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;
        document.getElementById("totalUnpaid").innerText = `${guardian.unpaid_total.toFixed(2)} دينار`;
    
        // جلب بيانات جميع الطلاب
        const students = await fetch("students.json").then(res => res.json());
        
        // تصفية الطلاب للعثور على أبناء الولي الحالي
        const children = students.filter(student => guardian.student_ids.includes(student.id));
    
        // الحصول على الجداول لتعبئتها
        const childrenTable = document.getElementById("children").getElementsByTagName('tbody')[0];
        const paymentsTable = document.getElementById("payments").getElementsByTagName('tbody')[0];
    
        // تعبئة جداول البيانات
        children.forEach(student => {
            // إضافة صف جديد لجدول الأبناء
            let childRow = childrenTable.insertRow();
            childRow.innerHTML = `<td>${student.name} ${student.surname}</td><td>${student.educational_level}</td><td>${student.unpaid_total.toFixed(2)}</td><td>${student.absence_count.length}</td><td>${student.notes || ''}</td>`;
    
            // إضافة الدفعات غير الخالصة لهذا الطالب
            student.unpaid_periods.forEach(payment => {
                let paymentRow = paymentsTable.insertRow();
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });
        });

        // تجميع المستويات الدراسية لأبناء الولي (بدون تكرار)
        const relevantLevels = [...new Set(children.map(student => student.educational_level))];

        // استدعاء الدالة مع تمرير المستويات المجمعة
        buildSchedule("schedule", relevantLevels);
    });
  </script>
</body>
</html>
