<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بوابة الولي - مؤسسة الصالحي</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="شعار المؤسسة" class="logo">
    <h1>بوابة متابعة الولي</h1>
  </div>

  <div class="container">
    <h3>مرحباً بك في بوابة الولي</h3>
    <p>
      في هذه الصفحة، ستجد ملخصًا شاملاً لمتابعة المسار الدراسي لأبنائك. يمكنك الاطلاع على قائمة أبنائك المسجلين مع تفاصيل ديونهم و غياباتهم، بالإضافة إلى جدول الدفعات غير الخالصة وجدول الحصص الأسبوعي.
    </p>
    <hr>

    <h2 id="guardianName"></h2>

    <h3>أبناؤك</h3>
    <div class="table-responsive">
      <table id="children" class="datatable">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>المستوى</th>
            <th>الديون</th>
            <th>عدد الغيابات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="totalUnpaidContainer">إجمالي الدفعات غير الخالصة: <span id="totalUnpaid" style="font-size: 1.2em; color: #d9534f; font-weight: bold;"></span></p>

    <h3>الدفعات غير الخالصة</h3>
    <div class="table-responsive">
      <table id="payments" class="datatable">
        <thead>
          <tr><th>الفترة</th><th>المبلغ</th><th>التلميذ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <hr>
    <h3>الغيابات</h3>
    <div class="table-responsive">
      <table id="absences" class="datatable">
          <thead>
              <tr>
                  <th>التلميذ</th>
                  <th>تاريخ الغياب</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>

    <hr>
    <h3>ملاحظات هامة</h3>
    <div class="table-responsive">
      <table id="notes" class="datatable">
          <thead>
              <tr>
                  <th>التلميذ</th>
                  <th>الملاحظة</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>

    <h3>إرسال ملاحظة للإدارة</h3>
    <div id="leaveNoteSection" style="margin-top: 15px;">
      <p>اختر التلميذ واكتب ملاحظتك، ثم اختر طريقة الإرسال المفضلة لديك.</p>
      
      <label for="noteStudentSelect">التلميذ المعني:</label>
      <select id="noteStudentSelect" style="width: 100%; padding: 8px; margin-bottom: 10px;"></select>
      
      <label for="noteTextarea">نص الملاحظة (للإرسال عبر البريد الإلكتروني):</label>
      <textarea id="noteTextarea" rows="4" placeholder="اكتب ملاحظتك هنا..." style="width: 100%; padding: 8px; margin-bottom: 10px;"></textarea>
      
      <div style="display: flex; gap: 10px;">
        <button id="sendNoteButtonEmail" style="padding: 10px 15px; cursor: pointer; flex: 1;">إرسال عبر البريد الإلكتروني</button>
        <button id="sendNoteButtonMessenger" style="padding: 10px 15px; cursor: pointer; background-color: #0084ff; color: white; border-color: #0084ff; flex: 1;">إرسال عبر ماسنجر</button>
      </div>
      <p style="font-size: 0.9em; margin-top: 10px;">
        <strong>ملاحظة:</strong> عند استخدام ماسنجر، سيتم فتح نافذة محادثة جديدة. ستحتاج إلى كتابة رسالتك هناك.
      </p>
    </div>

    <h3>جدول الحصص الخاص بأبنائك</h3>
    <div class="table-responsive">
      <table id="schedule" class="timetable">
        <thead>
          <tr>
            <th>التوقيت</th>
            <th>الإثنين</th>
            <th>الثلاثاء</th>
            <th>الأربعاء</th>
            <th>الخميس</th>
            <th>الجمعة</th>
            <th>السبت</th>
            <th>الأحد</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">العودة للصفحة الرئيسية</a>
    <p>حقوق النشر © 2025 الصالحي — جميع الحقوق محفوظة</p>
  </div>

  <script src="guardian_script.js"></script>
  
  <script>
    // --- الكود المدمج والمحدث بالكامل ---

    async function buildSchedule(tableId, relevantLevels = [], childrenIds = [], isChildInEnglishGroup = false) {
      const perm = await fetch("schedule_permanent.json").then(r => r.json());
      const temp = await fetch("schedule_temporary.json").then(r => r.json());
      
      const replacedClassIds = new Set(temp.filter(t => t.replaced_class_id !== null).map(t => t.replaced_class_id));
      const allTimeSlots = [...new Set([...perm.map(c => c.time_slot), ...temp.map(c => c.time_slot)])].sort();
      const days = ["الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت", "الأحد"];
      
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "";

      allTimeSlots.forEach(slot => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${slot}</td>`;
        days.forEach(day => {
          const cell = document.createElement("td");
          const permMatch = perm.find(c => c.time_slot === slot && c.day_of_week === day);

          if (permMatch && !replacedClassIds.has(permMatch.id)) {
            let shouldDisplay = false;
            
            // <<< تعديل 1: إضافة شرط حصة الإنجليزية >>>
            if (permMatch.class_type === 'english' && isChildInEnglishGroup) {
                shouldDisplay = true;
            } else if (relevantLevels.includes(permMatch.educational_level)) {
              if (permMatch.class_type === 'general') {
                shouldDisplay = true;
              } else if (permMatch.class_type === 'private') {
                if (permMatch.student_ids.some(studentId => childrenIds.includes(studentId))) {
                  shouldDisplay = true;
                }
              }
            }

            if (shouldDisplay) {
              cell.textContent = permMatch.educational_level === 'مجموعة إنجليزية' ? 'حصة إنجليزية' : permMatch.educational_level;
              cell.classList.add(permMatch.class_type);
            }
          }
          tr.appendChild(cell);
        });
        tbody.appendChild(tr);
      });

      if (!document.querySelector('.legend')) {
          const legend = document.createElement("div");
          legend.classList.add("legend");
          // <<< تعديل 2: إضافة مفتاح اللون الجديد >>>
          const legendItems = [
            { text: "حصة عامة", colorClass: "general" },
            { text: "حصة خاصة", colorClass: "private" },
            { text: "حصة إنجليزية", colorClass: "english" }
          ];
          legendItems.forEach(item => {
            const legendItem = document.createElement("div");
            legendItem.classList.add("legend-item");
            legendItem.innerHTML = `<span class="legend-color ${item.colorClass}"></span>${item.text}`;
            legend.appendChild(legendItem);
          });
          document.querySelector(`#${tableId}`).after(legend);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            window.location = "login.html";
            return;
        }

        const guardian = JSON.parse(guardianData);
        const students = await fetch("students.json").then(res => res.json());
        // <<< تعديل 3: افترض أن ملف الطلاب سيحتوي على معلومة الانتماء للمجموعة >>>
        // ملاحظة: ستحتاج إلى تعديل دالة التصدير لإضافة `is_in_english_group`
        const children = students.filter(student => guardian.student_ids.includes(student.id));

        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;
        document.getElementById("totalUnpaid").innerText = `${guardian.unpaid_total.toFixed(2)} دينار`;

        const childrenTableBody = document.getElementById("children").getElementsByTagName('tbody')[0];
        childrenTableBody.innerHTML = ''; 
        
        children.forEach(student => {
          let childRow = childrenTableBody.insertRow();
          childRow.innerHTML = `<td>${student.name} ${student.surname}</td>
                                <td>${student.educational_level}</td>
                                <td>${student.unpaid_total.toFixed(2)}</td>
                                <td>${Array.isArray(student.absence_count) ? student.absence_count.length : 0}</td>`;
        });

        const paymentsTableBody = document.getElementById("payments").getElementsByTagName('tbody')[0];
        paymentsTableBody.innerHTML = '';
        children.forEach(student => {
            student.unpaid_periods.forEach(payment => {
                let paymentRow = paymentsTableBody.insertRow(); 
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });
        });
        
        // ... (باقي الكود الخاص بالغيابات والملاحظات يبقى كما هو)
        const absencesTableBody = document.getElementById("absences").getElementsByTagName('tbody')[0];
        const notesTableBody = document.getElementById("notes").getElementsByTagName('tbody')[0];
        // ...

        const relevantLevels = [...new Set(children.map(student => student.educational_level))];
        const childrenIds = children.map(student => student.id);
        // <<< تعديل 4: التحقق مما إذا كان أي من الأبناء في مجموعة الإنجليزية >>>
        const isChildInEnglishGroup = children.some(child => child.is_in_english_group === true);

        await buildSchedule("schedule", relevantLevels, childrenIds, isChildInEnglishGroup);

        const noteStudentSelect = document.getElementById('noteStudentSelect');
        if (children.length > 0) {
            children.forEach(child => {
                const option = document.createElement('option');
                option.value = `${child.name} ${child.surname}`;
                option.textContent = `${child.name} ${child.surname}`;
                noteStudentSelect.appendChild(option);
            });
        } else {
             document.getElementById('leaveNoteSection').innerHTML = "<p>لا يوجد أبناء مسجلون لترك ملاحظات حولهم.</p>";
        }

        document.getElementById('sendNoteButton')?.addEventListener('click', () => {
            const studentName = noteStudentSelect.value;
            const noteContent = document.getElementById('noteTextarea').value;
            const guardianName = guardian.guardian_full_name;
            const adminEmail = "aymenraggam@gmail.com"; 

            if (!noteContent.trim()) {
                alert('الرجاء كتابة الملاحظة قبل الإرسال.');
                return;
            }

            const subject = `ملاحظة من ولي الأمر: ${guardianName} (بخصوص الطالب: ${studentName})`;
            const body = `السلام عليكم،\n\n` +
                         `لدي ملاحظة بخصوص ابني/ابنتي: ${studentName}.\n\n` +
                         `نص الملاحظة:\n${noteContent}\n\n` +
                         `مع الشكر،\n${guardianName}`;

            // يقوم بفتح تطبيق البريد الإلكتروني مع تعبئة البيانات
            window.location.href = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        });
        // --- أضف هذا الكود الجديد لزر الماسنجر ---
        document.getElementById('sendNoteButtonMessenger')?.addEventListener('click', () => {
            // !!! هام: قم بملء هذه البيانات
            // اسم المستخدم لصفحتك (للحل الاحتياطي)
            const facebookPageUsername = "aymenstam"; 
            // الرقم التعريفي الذي حصلت عليه في الخطوة 1
            const facebookPageId = "770223689507881"; // <--- ضع الرقم التعريفي هنا
        
            if (!facebookPageId || facebookPageId === "123456789012345") {
                alert("خاصية الماسنجر غير مُعدّة بشكل صحيح. يرجى إدخال الرقم التعريفي للصفحة.");
                return;
            }
        
            // التحقق مما إذا كان الجهاز هاتفاً محمولاً
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
            if (isMobile) {
                // على الموبايل: نحاول فتح التطبيق مباشرة
                document.location = `fb-messenger://user-thread/${facebookPageId}`;
        
                // بعد 1.5 ثانية، إذا كان المستخدم لا يزال في المتصفح، نوجهه إلى رابط الويب
                setTimeout(() => {
                    window.location.href = `https://m.me/${facebookPageUsername}`;
                }, 1500);
        
            } else {
                // على الحاسوب: نستخدم الطريقة التقليدية التي تعمل بشكل جيد
                window.open(`https://m.me/${facebookPageUsername}`, '_blank');
            }
        });

      } catch (error) {
        console.error("حدث خطأ:", error);
        alert("عفواً، حدث خطأ أثناء تحميل بيانات الصفحة. قد تكون البيانات غير مكتملة.");
      }
    });
  </script>
</body>
</html>
