<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بوابة الولي - مؤسسة الصالحي</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="شعار المؤسسة" class="logo">
    <h1>بوابة متابعة الولي</h1>
  </div>

  <div class="container">
    <h3>مرحباً بك في بوابة الولي</h3>
    <p>
      في هذه الصفحة، ستجد ملخصًا شاملاً لمتابعة المسار الدراسي لأبنائك. يمكنك الاطلاع على قائمة أبنائك المسجلين مع تفاصيل ديونهم و غياباتهم، بالإضافة إلى جدول الدفعات غير الخالصة وجدول الحصص الأسبوعي.
    </p>
    <hr>

    <h2 id="guardianName"></h2>

    <h3>أبناؤك</h3>
    <table id="children" class="datatable">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>المستوى</th>
          <th>الديون</th>
          <th>عدد الغيابات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="totalUnpaidContainer">إجمالي الدفعات غير الخالصة: <span id="totalUnpaid" style="font-size: 1.2em; color: #d9534f; font-weight: bold;"></span></p>

    <h3>الدفعات غير الخالصة</h3>
    <table id="payments" class="datatable">
      <thead>
        <tr><th>الفترة</th><th>المبلغ</th><th>الطالب</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr>
    <h3>الغيابات</h3>
    <table id="absences" class="datatable">
        <thead>
            <tr>
                <th>الطالب</th>
                <th>تاريخ الغياب</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>
    <h3>ملاحظات هامة</h3>
    <table id="notes" class="datatable">
        <thead>
            <tr>
                <th>الطالب</th>
                <th>الملاحظة</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>جدول الحصص الخاص بأبنائك</h3>
    <table id="schedule" class="timetable">
      <thead>
        <tr>
          <th>التوقيت</th>
          <th>الإثنين</th>
          <th>الثلاثاء</th>
          <th>الأربعاء</th>
          <th>الخميس</th>
          <th>الجمعة</th>
          <th>السبت</th>
          <th>الأحد</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">
    <a href="index.html">العودة للصفحة الرئيسية</a>
    <p>حقوق النشر © 2025 الصالحي — جميع الحقوق محفوظة</p>
  </div>

  <script src="guardian_script.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            window.location = "login.html";
            return;
        }

        const guardian = JSON.parse(guardianData);
        const students = await fetch("students.json").then(res => res.json());
        const children = students.filter(student => guardian.student_ids.includes(student.id));

        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;

        // حساب إجمالي الديون من الأبناء
        const totalUnpaid = children.reduce((sum, s) => sum + (Number(s.unpaid_total) || 0), 0);
        document.getElementById("totalUnpaid").innerText = `${totalUnpaid.toFixed(2)} دينار`;

        const childrenTableBody = document.getElementById("children").getElementsByTagName('tbody')[0];
        childrenTableBody.innerHTML = ''; 
        
        children.forEach(student => {
          let childRow = childrenTableBody.insertRow();
          let cell1 = childRow.insertCell(); cell1.textContent = `${student.name} ${student.surname}`;
          let cell2 = childRow.insertCell(); cell2.textContent = student.educational_level;
          let cell3 = childRow.insertCell(); cell3.textContent = student.unpaid_total.toFixed(2);
          let cell4 = childRow.insertCell(); cell4.textContent = Array.isArray(student.absence_count) ? student.absence_count.length : 0;
        });

        // جدول الدفعات
        const paymentsTableBody = document.getElementById("payments").getElementsByTagName('tbody')[0];
        paymentsTableBody.innerHTML = '';
        children.forEach(student => {
            student.unpaid_periods.forEach(payment => {
                let paymentRow = paymentsTableBody.insertRow(); 
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });
        });

        // جدول الغيابات
        const absencesTableBody = document.getElementById("absences").getElementsByTagName('tbody')[0];
        absencesTableBody.innerHTML = '';
        const notesTableBody = document.getElementById("notes").getElementsByTagName('tbody')[0];
        const daysOfWeek = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];

        let hasAbsences = false;

        children.forEach(student => {
            if (Array.isArray(student.absence_count) && student.absence_count.length > 0) {
                student.absence_count.forEach(absenceDate => {
                    let absenceRow = absencesTableBody.insertRow();
                    const d = new Date(absenceDate);
                    let formattedDate = absenceDate;
                    if (!isNaN(d)) {
                        const dayName = daysOfWeek[d.getDay()];
                        formattedDate = `${absenceDate} (${dayName})`;
                    }
                    absenceRow.innerHTML = `<td>${student.name}</td><td>${formattedDate}</td>`;
                    hasAbsences = true;
                });
            }
            if (student.notes) {
                let noteRow = notesTableBody.insertRow();
                noteRow.innerHTML = `<td>${student.name}</td><td>${student.notes}</td>`;
            }
        });

        if (!hasAbsences) {
            let row = absencesTableBody.insertRow();
            row.innerHTML = `<td colspan="2">لا توجد غيابات مسجلة</td>`;
        }

        const relevantLevels = [...new Set(children.map(student => student.educational_level))];
        const childrenIds = children.map(student => student.id);

        try {
          await buildSchedule("schedule", relevantLevels, childrenIds);
        } catch (e) {
          console.warn("تعذّر تحميل جدول الحصص؛ سيتم تجاهله مؤقتًا.", e);
        }

      } catch (error) {
        console.error("حدث خطأ:", error);
        alert("عفواً، حدث خطأ أثناء تحميل بيانات الصفحة. قد تكون البيانات غير مكتملة.");
      }
    });
  </script>
</body>
</html>
