<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بوابة الولي - مؤسسة الصالحي</title>
  <link rel="stylesheet" href="style.css">
  
  <style>
    #sendNoteButtonMessenger {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    #sendNoteButtonMessenger svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
  </style>
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="شعار المؤسسة" class="logo">
    <h1>بوابة متابعة الولي</h1>
  </div>

  <div class="container">
    <h3>مرحباً بك في بوابة الولي</h3>
    <p>
      في هذه الصفحة، ستجد ملخصًا شاملاً لمتابعة المسار الدراسي لأبنائك. يمكنك الاطلاع على قائمة أبنائك المسجلين مع تفاصيل ديونهم و غياباتهم، بالإضافة إلى جدول الدفعات غير الخالصة وجدول الحصص الأسبوعي.
    </p>
    <hr>

    <h2 id="guardianName"></h2>

    <h3>أبناؤك</h3>
    <div class="table-responsive">
      <table id="children" class="datatable">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>المستوى</th>
            <th>الديون</th>
            <th>عدد الغيابات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="totalUnpaidContainer">إجمالي الدفعات غير الخالصة: <span id="totalUnpaid" style="font-size: 1.2em; color: #d9534f; font-weight: bold;"></span></p>

    <h3>الدفعات غير الخالصة</h3>
    <div class="table-responsive">
      <table id="payments" class="datatable">
        <thead>
          <tr><th>الفترة</th><th>المبلغ</th><th>التلميذ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <hr>
    <h3>الغيابات</h3>
    <div class="table-responsive">
      <table id="absences" class="datatable">
          <thead>
              <tr>
                  <th>التلميذ</th>
                  <th>تاريخ الغياب</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>

    <hr>
    <h3>ملاحظات هامة</h3>
    <div class="table-responsive">
      <table id="notes" class="datatable">
          <thead>
              <tr>
                  <th>التلميذ</th>
                  <th>الملاحظة</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>
    
    <hr>
    <h3>إعلانات هامة</h3>
    <div class="table-responsive">
      <table id="generalAnnouncements" class="datatable">
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>الإعلان</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>إرسال ملاحظة للإدارة</h3>
    <div id="leaveNoteSection" style="margin-top: 15px;">
      <p>لإرسال ملاحظة للإدارة، اضغط على الزر أدناه للانتقال إلى ماسنجر وكتابة رسالتك مباشرة.</p>
      
      <button id="sendNoteButtonMessenger" style="width: 100%; padding: 12px 15px; cursor: pointer; background-color: #0084ff; color: white; border: none; border-radius: 5px; font-size: 1.1em;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256.55 8C116.52 8 8 110.34 8 248.57c0 72.3 34.81 135.62 92.87 177.65 4.39 3.16 6.36 8.24 5.36 13.4-2.58 13.4-11.43 54.43-11.58 55.43-.17 1.12.02 2.33.58 3.39.57 1.06 1.54 1.83 2.72 2.22 1.17.4 2.48.23 3.54-.42l65.1-41.1c4.15-2.62 9.17-3.47 13.96-2.52 31.25 6.19 63.8 9.38 96.46 9.38 140.03 0 248.55-102.34 248.55-240.58C504.58 110.34 396.58 8 256.55 8zM240.5 352.62l-64.8-64.62 136.37-142.38 64.79 64.63-136.36 142.37z"/></svg>
        <span>مراسلة الإدارة عبر ماسنجر</span>
      </button>
    </div>

    <div id="permanent-schedule-container" style="display: none;">
        <h3>جدول الحصص الخاص بأبنائك (إعدادي وثانوي)</h3>
        <div class="table-responsive">
          <table id="schedule" class="timetable">
            <thead>
              <tr>
                <th>التوقيت</th>
                <th>الإثنين</th>
                <th>الثلاثاء</th>
                <th>الأربعاء</th>
                <th>الخميس</th>
                <th>الجمعة</th>
                <th>السبت</th>
                <th>الأحد</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
    </div>
    
    <div id="primary-schedule-container" style="display: none;">
        <h3>جدول الحصص الخاص بأبنائك (ابتدائي)</h3>
        <div class="table-responsive">
          <table id="primary-schedule" class="timetable">
            <thead>
              <tr>
                <th>التوقيت</th>
                <th>الإثنين</th>
                <th>الثلاثاء</th>
                <th>الأربعاء</th>
                <th>الخميس</th>
                <th>الجمعة</th>
                <th>السبت</th>
                <th>الأحد</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
    </div>

  </div>

  <div class="footer">
    <a href="index.html">العودة للصفحة الرئيسية</a>
    <p>حقوق النشر © 2025 الصالحي — جميع الحقوق محفوظة</p>
  </div>
  
  <script src="schedule_primary_script.js"></script>

  <script>
    // --- الكود المدمج والمحدث بالكامل ---

    // دالة بناء جدول الإعدادي والثانوي (موجودة لديك ولكن نضعها هنا للتأكيد)
    async function buildSchedule(tableId, children = [], isChildInEnglishGroup = false) {
      const perm = await fetch("schedule_permanent.json").then(r => r.json());
      const temp = await fetch("schedule_temporary.json").then(r => r.json());
      
      const replacedClassIds = new Set(temp.filter(t => t.replaced_class_id !== null).map(t => t.replaced_class_id));
      const allTimeSlots = [...new Set(perm.map(c => c.time_slot))].sort();
      const days = ["الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت", "الأحد"];
      
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "";

      const relevantLevels = [...new Set(children.map(student => student.educational_level))];

      allTimeSlots.forEach(slot => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${slot}</td>`;
        days.forEach(day => {
          const cell = document.createElement("td");
          const permMatch = perm.find(c => c.time_slot === slot && c.day_of_week === day);

          if (permMatch && !replacedClassIds.has(permMatch.id)) {
            if (permMatch.class_type === 'private') {
              const enrolledChildren = children.filter(child => permMatch.student_ids.includes(child.id));
              if (enrolledChildren.length > 0) {
                const studentNames = enrolledChildren.map(child => child.name).join(', ');
                cell.textContent = studentNames;
                cell.classList.add('private');
              }
            } else if (permMatch.class_type === 'general' && relevantLevels.includes(permMatch.educational_level)) {
                cell.textContent = permMatch.educational_level;
                cell.classList.add('general');
            } else if (permMatch.class_type === 'english' && isChildInEnglishGroup) {
                cell.textContent = 'حصة إنجليزية';
                cell.classList.add('english');
            }
          }
          tr.appendChild(cell);
        });
        tbody.appendChild(tr);
      });

      const container = document.querySelector(`#${tableId}`).closest('.table-responsive');
      if (container && !container.querySelector('.legend')) {
          const legend = document.createElement("div");
          legend.classList.add("legend");
          const legendItems = [
            { text: "حصة عامة", colorClass: "general" },
            { text: "حصة خاصة", colorClass: "private" },
            { text: "حصة إنجليزية", colorClass: "english" }
          ];
          legendItems.forEach(item => {
            const legendItem = document.createElement("div");
            legendItem.classList.add("legend-item");
            legendItem.innerHTML = `<span class="legend-color ${item.colorClass}"></span>${item.text}`;
            legend.appendChild(legendItem);
          });
          container.appendChild(legend);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            window.location = "login.html";
            return;
        }

        const guardian = JSON.parse(guardianData);
        const students = await fetch("students.json").then(res => res.json());
        const children = students.filter(student => guardian.student_ids.includes(student.id));

        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;
        document.getElementById("totalUnpaid").innerText = `${guardian.unpaid_total.toFixed(2)} دينار`;

        // ... (بقية الكود الخاص بملء جداول الأبناء والمدفوعات والغيابات يبقى كما هو)
        const childrenTableBody = document.getElementById("children").getElementsByTagName('tbody')[0];
        childrenTableBody.innerHTML = ''; 
        children.forEach(student => {
          let childRow = childrenTableBody.insertRow();
          childRow.innerHTML = `<td>${student.name} ${student.surname}</td>
                                <td>${student.educational_level}</td>
                                <td>${student.unpaid_total.toFixed(2)}</td>
                                <td>${Array.isArray(student.absence_count) ? student.absence_count.length : 0}</td>`;
        });
        const paymentsTableBody = document.getElementById("payments").getElementsByTagName('tbody')[0];
        paymentsTableBody.innerHTML = '';
        children.forEach(student => {
            student.unpaid_periods.forEach(payment => {
                let paymentRow = paymentsTableBody.insertRow(); 
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });
        });
        const absencesTableBody = document.getElementById("absences").getElementsByTagName('tbody')[0];
        absencesTableBody.innerHTML = '';
        children.forEach(student => {
            if (student.absence_count && Array.isArray(student.absence_count)) {
                student.absence_count.forEach(absenceDate => {
                    let absenceRow = absencesTableBody.insertRow();
                    absenceRow.innerHTML = `<td>${student.name}</td><td>${absenceDate}</td>`;
                });
            }
        });
        const notesTableBody = document.getElementById("notes").getElementsByTagName('tbody')[0];
        notesTableBody.innerHTML = '';
        children.forEach(student => {
            if (student.notes && student.notes.trim() !== "") {
                let noteRow = notesTableBody.insertRow();
                noteRow.innerHTML = `<td>${student.name}</td><td>${student.notes}</td>`;
            }
        });
        const announcementsTableBody = document.getElementById("generalAnnouncements").getElementsByTagName('tbody')[0];
        try {
            const announcementsResponse = await fetch("announcements.json");
            if (announcementsResponse.ok) {
                const announcements = await announcementsResponse.json();
                announcementsTableBody.innerHTML = '';
                announcements.forEach(announcement => {
                    let announcementRow = announcementsTableBody.insertRow();
                    announcementRow.innerHTML = `<td>${announcement.date}</td><td>${announcement.text}</td>`;
                });
            }
        } catch (error) {
            console.error("حدث خطأ في جلب الإعلانات العامة. الرجاء اعادة المحاولة لاحقا:", error);
        }
        // --- المنطق الجديد لعرض الجداول ---

        // 1. فصل الأبناء إلى مجموعتين: ابتدائي وإعدادي/ثانوي
        const primaryChildren = children.filter(c => c.educational_level.includes('ابتدائي'));
        const prepSecondaryChildren = children.filter(c => !c.educational_level.includes('ابتدائي'));

        // 2. بناء وعرض الجداول بناءً على المجموعات
        if (primaryChildren.length > 0) {
            document.getElementById('primary-schedule-container').style.display = 'block';
            await buildPrimarySchedule('primary-schedule');
        }

        if (prepSecondaryChildren.length > 0) {
            document.getElementById('permanent-schedule-container').style.display = 'block';
            const isChildInEnglishGroup = prepSecondaryChildren.some(child => child.is_in_english_group === true);
            await buildSchedule("schedule", prepSecondaryChildren, isChildInEnglishGroup);
        }

        // ... (بقية الكود الخاص بزر المراسلة يبقى كما هو)
        if (children.length === 0) {
            const leaveNoteSection = document.getElementById('leaveNoteSection');
            if(leaveNoteSection) {
                leaveNoteSection.style.display = 'none';
            }
        }
        document.getElementById('sendNoteButtonMessenger')?.addEventListener('click', () => {
            const facebookPageId = "770223689507881"; 
            if (!facebookPageId || facebookPageId === "123456789012345") {
                alert("خاصية الماسنجر غير مُعدّة بشكل صحيح. يرجى إدخال الرقم التعريفي للصفحة.");
                return;
            }
            const messengerLink = `https://m.me/${facebookPageId}`;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
            if (isMobile) {
                document.location = `fb-messenger://user-thread/${facebookPageId}`;
                setTimeout(() => {
                    window.location.href = messengerLink;
                }, 1500);
            } else {
                window.open(messengerLink, '_blank');
            }
        });

      } catch (error) {
        console.error("حدث خطأ:", error);
        alert("عفواً، حدث خطأ أثناء تحميل بيانات الصفحة. قد تكون البيانات غير مكتملة.");
      }
    });
  </script>
</body>
</html>
