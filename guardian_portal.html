<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بوابة الولي - مؤسسة الصالحي</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="شعار المؤسسة" class="logo">
    <h1>بوابة متابعة الولي</h1>
  </div>

  <div class="container">
    <h3>مرحباً بك في بوابة الولي</h3>
    <p>
      في هذه الصفحة، ستجد ملخصًا شاملاً لمتابعة المسار الدراسي لأبنائك. يمكنك الاطلاع على قائمة أبنائك المسجلين مع تفاصيل ديونهم و غياباتهم، بالإضافة إلى جدول الدفعات غير الخالصة وجدول الحصص الأسبوعي.
    </p>
    <hr>

    <h2 id="guardianName"></h2>

    <h3>أبناؤك</h3>
    <table id="children" class="datatable">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>المستوى</th>
          <th>الديون</th>
          <th>الغيابات</th>
          <th>ملاحظات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p>إجمالي الدفعات غير الخالصة: <span id="totalUnpaid" style="font-size: 1.2em; color: #d9534f; font-weight: bold;"></span></p>

    <h3>الدفعات غير الخالصة</h3>
    <table id="payments" class="datatable">
      <thead>
        <tr><th>الفترة</th><th>المبلغ</th><th>الطالب</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>جدول الحصص الخاص بأبنائك</h3>
    <table id="schedule" class="timetable">
      <thead>
        <tr>
          <th>التوقيت</th>
          <th>الإثنين</th>
          <th>الثلاثاء</th>
          <th>الأربعاء</th>
          <th>الخميس</th>
          <th>الجمعة</th>
          <th>السبت</th>
          <th>الأحد</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">
    <a href="index.html">العودة للصفحة الرئيسية</a>
    <p>حقوق النشر © 2025 الصالحي — جميع الحقوق محفوظة</p>
  </div>

  <script src="guardian_script.js"></script>
  
  <script>
    // --- الكود المدمج ---

    async function buildSchedule(tableId, relevantLevels = [], childrenIds = []) {
      // This function remains unchanged
      const perm = await fetch("schedule_permanent.json").then(r => r.json());
      const temp = await fetch("schedule_temporary.json").then(r => r.json());
      const replacedClassIds = new Set(temp.filter(t => t.replaced_class_id !== null).map(t => t.replaced_class_id));
      const allTimeSlots = [...new Set([...perm.map(c => c.time_slot), ...temp.map(c => c.time_slot)])].sort();
      const days = ["الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت", "الأحد"];
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "";
      allTimeSlots.forEach(slot => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${slot}</td>`;
        days.forEach(day => {
          const cell = document.createElement("td");
          const permMatch = perm.find(c => c.time_slot === slot && c.day_of_week === day);
          if (permMatch && !replacedClassIds.has(permMatch.id)) {
            let shouldDisplay = false;
            if (relevantLevels.includes(permMatch.educational_level)) {
              if (permMatch.class_type === 'general') { shouldDisplay = true; }
              else if (permMatch.class_type === 'private') {
                if (permMatch.student_ids.some(studentId => childrenIds.includes(studentId))) { shouldDisplay = true; }
              }
            }
            if (shouldDisplay) {
              cell.textContent = permMatch.educational_level;
              cell.classList.add(permMatch.class_type);
            }
          }
          tr.appendChild(cell);
        });
        tbody.appendChild(tr);
      });
      if (!document.querySelector('.legend')) {
          const legend = document.createElement("div");
          legend.classList.add("legend");
          const legendItems = [{ text: "حصة عامة", colorClass: "general" },{ text: "حصة خاصة", colorClass: "private" },];
          legendItems.forEach(item => {
            const legendItem = document.createElement("div");
            legendItem.classList.add("legend-item");
            legendItem.innerHTML = `<span class="legend-color ${item.colorClass}"></span>${item.text}`;
            legend.appendChild(legendItem);
          });
          document.querySelector(`#${tableId}`).after(legend);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const guardianData = sessionStorage.getItem("guardian");
        if (!guardianData) {
            window.location = "login.html";
            return;
        }

        const guardian = JSON.parse(guardianData);
        const students = await fetch("students.json").then(res => res.json());
        const children = students.filter(student => guardian.student_ids.includes(student.id));

        document.getElementById("guardianName").innerText = `مرحباً، ${guardian.guardian_full_name}`;
        document.getElementById("totalUnpaid").innerText = `${guardian.unpaid_total.toFixed(2)} دينار`;

        const childrenTableBody = document.getElementById("children").getElementsByTagName('tbody')[0];
        childrenTableBody.innerHTML = ''; 
        
        children.forEach(student => {
          let childRow = childrenTableBody.insertRow();
          let cell1 = childRow.insertCell(); cell1.textContent = `${student.name} ${student.surname}`;
          let cell2 = childRow.insertCell(); cell2.textContent = student.educational_level;
          let cell3 = childRow.insertCell(); cell3.textContent = student.unpaid_total.toFixed(2);
          let cell4 = childRow.insertCell(); cell4.textContent = Array.isArray(student.absence_count) ? student.absence_count.length : 0;
          let cell5 = childRow.insertCell(); cell5.textContent = student.notes || '-';
        });

        // --== الجزء الذي تم تصحيحه ==--
        const paymentsTableBody = document.getElementById("payments").getElementsByTagName('tbody')[0];
        paymentsTableBody.innerHTML = '';
        children.forEach(student => {
            student.unpaid_periods.forEach(payment => {
                // تم تصحيح الخطأ الإملائي هنا
                let paymentRow = paymentsTableBody.insertRow(); 
                paymentRow.innerHTML = `<td>${payment.period}</td><td>${payment.amount.toFixed(2)}</td><td>${student.name}</td>`;
            });
        });

        const relevantLevels = [...new Set(children.map(student => student.educational_level))];
        const childrenIds = children.map(student => student.id);

        await buildSchedule("schedule", relevantLevels, childrenIds);

      } catch (error) {
        // سأترك هذا التنبيه في حال وجود خطأ آخر غير متوقع
        console.error("حدث خطأ:", error);
        alert("عفواً، حدث خطأ أثناء تحميل بيانات الصفحة. قد تكون البيانات غير مكتملة.");
      }
    });
  </script>
</body>
</html>
